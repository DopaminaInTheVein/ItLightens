try(DestroyDialog RigidAnimExportRollout)catch()
----------------------------------------------------------------
-- GUI Stuff (Generated by VMS and incrustated here by the morro)
rollout RigidAnimExportRollout "<RigidAnimation> Exporter" width:256 height:180
(
  ---------------------------------------------------------------------------------
  -- Widgets
  ---------------------------------------------------------------------------------

  button BT_Export "Export" pos:[16,148] width:40 height:24
  button BT_Cancel "Cancel" pos:[200,148] width:40 height:24
  spinner SPN_StartFrame "Start" pos:[152,76] width:80 height:16 enabled:false range:[0,100,0] type:#integer scale:1
  spinner SPN_EndFrame " End" pos:[152,100] width:80 height:16 enabled:false range:[0,100,0] type:#integer scale:1
  groupBox grp1 "Frame Range" pos:[16,52] width:224 height:80
  radioButtons RB_FrameRangeMode "" pos:[25,75] width:115 height:48 labels:#("Full Sequence", "Displayed TimeLine", "Specify Frames") default:2 columns:1
  spinner SPN_FrameRate "Sampling Rate" pos:[40,28] width:192 height:16 range:[15,120,30] type:#integer scale:1

  ---------------------------------------------------------------------------------
  -- Utility methods
  ---------------------------------------------------------------------------------

  -- RB_FrameRangeMode States:
  --  1) Full Sequence (selects only animated frame-range of selected node and children)
  --  2) Displayed TimeLine
  --  3) Specify Frames (enables user specification of the frame-range)
  function GetSelectedAnimationFrameRange =
  (
    if RB_FrameRangeMode.state == 1 then
    (
        return animationRange
    )
    else if RB_FrameRangeMode.state == 2 then
    (
        return animationRange
    )
    else
    (
        return (interval SPN_StartFrame.value SPN_EndFrame.value)
    )
  )

  ---------------------------------------------------------------------------------
  -- Actions
  ---------------------------------------------------------------------------------

  on RigidAnimExportRollout open do
  (
    -- Init the Spinners to the whole scene frame range
    range = animationRange
    SPN_StartFrame.range = [range.start, range.end, range.start]
    SPN_EndFrame.range = [range.start, range.end, range.end]
  )
  
  on BT_Cancel pressed do
  (
    DestroyDialog IRFAnimationExport
  )

  -- RB_FrameRangeMode States:
  --  1) Full Sequence (selects only animated frame-range of selected node and children)
  --  2) Displayed TimeLine
  --  3) Specify Frames (enables user specification of the frame-range)
  on RB_FrameRangeMode changed new_state do
  (        
    if new_state == 1 then
    (
       SPN_StartFrame.enabled = false
       SPN_EndFrame.enabled = false
    )
    else if new_state == 2 then
    (
       SPN_StartFrame.enabled = false
       SPN_EndFrame.enabled = false
    )
    else
    (
       SPN_StartFrame.enabled = true
       SPN_EndFrame.enabled = true
    )
  )

  -- Tries to export using the current settings, and returns true if
  -- succeeds or false if fails
  on BT_Export pressed do
  (
    if selection.count == 0 then
    (
      messagebox "No Rigid node Selected!"
      return false
    )
    else if selection.count > 1 then
    (
      messagebox "Only 1 Rigid node must be selected!"
      return false
    )
    else
    (
      -- Get save filename (extension automatically forced)
      -- NOTE: double-dot wildcards do not accept longer than 3 char
      -- middle string... MAXScript crashes!
      filename = getSaveFileName types:"Animation (*.xml)|*.xml|All|*.*"
	  messageBox (fileName as string)
      if filename != undefined do
      (
        -- Open or Create file
        f = openFile filename mode:"wt"
        if f == undefined do
          f = createFile filename        

        -- Build up frame interval from selected mode
        range = GetSelectedAnimationFrameRange()

        --Export
        result = ExportAnimation $ f SPN_FrameRate.value range
        close f

        -- Process results and show feedback
        if result[1] then
        (
          str = stringStream ""
          format "TimeRange = [ %, % ]\nDuration = %\nSampleRate = %\nNumFrames = %\n" \
                 result[2].start result[2].end result[3] result[4] result[5] to: str
          messagebox (str as string) title:"<RigidAnimation> Exported"
        )
        else
        (
          messagebox "Error while exporting <RigidAnimation>!\n" + result[2]
        )

        DestroyDialog RigidAnimExportRollout
      )
      return true
    )
  )

) -- END RigidAnimExportRollout
CreateDialog RigidAnimExportRollout
